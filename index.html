<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DeepTalk Pasangan â€” Kartu Flip + Daftar (Colorful)</title>
  <style>
    :root{
      /* ðŸŒˆ Tema colorful & cerah */
      --bg-grad:
        radial-gradient(1200px 800px at 8% -10%, #fff0f6 0%, #fff 60%),
        radial-gradient(1000px 700px at 110% 0%, #e0f7ff 0%, transparent 65%),
        radial-gradient(900px 700px at 50% 100%, #ecffec 0%, transparent 65%);

      /* Kartu: warna nge-pop tapi tetap lembut */
      --card-grad-front: linear-gradient(135deg,#ff8fab 0%,#ffd166 45%,#7dd3fc 75%,#86efac 100%);
      --card-grad-back: linear-gradient(180deg,#ffffff,#f8fafc);

      /* Warna umum */
      --edge:#e2e8f0;
      --text:#0b1222;    /* gelap untuk kontras di background cerah */
      --muted:#475569;   /* slate-600 */
      --accent:#ef4444;  /* merah coral */
      --accent-2:#22c55e;/* green */
      --accent-3:#0ea5e9;/* sky */
      --radius:22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background: var(--bg-grad);
      color:var(--text);
      display:grid; place-items:center;
    }
    .wrap{ width:min(1100px, 100%); padding:24px; }

    header{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px}
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{ width:38px; height:38px; border-radius:12px; background:conic-gradient(from 120deg,#ff8fab,#ffd166,#7dd3fc,#86efac,#ff8fab); box-shadow:0 10px 30px #fda4af55 inset; }
    h1{ font-size:20px; margin:0; letter-spacing:.3px }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; }
    button, .ghost{
      background:#ffffffcc; color:var(--text);
      border:1px solid var(--edge); border-radius:14px; padding:10px 14px; font-weight:700; cursor:pointer;
      transition:.2s ease; font-size:14px; line-height:1; backdrop-filter: blur(6px);
      box-shadow:0 6px 18px #00000012;
    }
    button:hover{ transform:translateY(-1px); box-shadow:0 10px 24px #00000018; border-color:#cbd5e1 }
    button.primary{ background:linear-gradient(180deg,#ffffff,#f8fafc); border-color:#dbeafe }
    button.accent{ background:linear-gradient(180deg,#fff7ed,#ffedd5); border-color:#fed7aa }
    button.accent:active{ box-shadow:0 0 0 6px #fed7aa66; }
    .ghost{ background:transparent }

    .stage{ display:grid; gap:18px; grid-template-columns: 1fr; }

    /* === Flip Card === */
    .card{ perspective:1200px; }
    .card-inner{
      position:relative; width:100%; min-height:260px; border-radius:var(--radius); cursor:pointer;
      transform-style:preserve-3d; transition:transform .6s cubic-bezier(.2,.8,.2,1);
    }
    .card.flipped .card-inner{ transform: rotateY(180deg); }

    .face{
      position:absolute; inset:0; border-radius:var(--radius); padding:28px;
      display:flex; align-items:center; justify-content:center; text-align:center;
      backface-visibility:hidden; -webkit-backface-visibility:hidden; overflow:hidden;
      border:1px solid var(--edge);
      box-shadow: 0 30px 90px #00000014, inset 0 1px 0 #ffffffee;
    }
    .front{ background: var(--card-grad-front); }
    .back{ background: var(--card-grad-back); transform: rotateY(180deg); }

    .front .label{ display:grid; gap:6px; align-items:center; justify-items:center; color:#0b1222; text-shadow:0 2px 12px #ffffffaa }
    .front .num{ font-weight:900; letter-spacing:.6px; font-size: clamp(18px, 2.4vw, 22px); text-transform:uppercase }
    .front .big{ font-size: clamp(42px, 6.6vw, 72px); font-weight:900; line-height:1; }
    .front .hint{ font-size:12px; opacity:.85 }

    .q{ font-size: clamp(20px, 3.2vw, 32px); line-height:1.35; letter-spacing:.2px; color:#0b1222 }

    .meta{ display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px; padding:0 4px; }

    /* === Drawer daftar pertanyaan === */
    .drawer{ position: fixed; top:0; right:0; height:100%; width:min(420px, 94%); background:#ffffffee; color:var(--text); border-left:1px solid var(--edge); box-shadow:-20px 0 80px #00000018; transform: translateX(100%); transition: transform .35s ease; z-index: 50; display:flex; flex-direction:column; backdrop-filter: blur(8px); }
    .drawer.open{ transform: translateX(0); }
    .drawer-head{ display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid var(--edge); background:#f8fafc }
    .drawer-body{ overflow:auto; padding:10px; display:grid; gap:12px; }
    .drawer .tabs{ display:flex; gap:6px; padding:10px; border-bottom:1px solid var(--edge); }
    .tab{ padding:8px 12px; border:1px solid var(--edge); border-radius:999px; background:#ffffff; cursor:pointer; font-weight:800; font-size:13px }
    .tab.active{ background:linear-gradient(90deg, var(--accent-3), var(--accent-2)); color:#ffffff; border-color:transparent }

    .item{ display:grid; gap:2px; padding:10px 12px; border:1px solid #e2e8f0; border-radius:12px; background: #ffffff; cursor:pointer; transition:.15s; box-shadow:0 6px 16px #0000000a }
    .item:hover{ transform: translateY(-1px); border-color:#cbd5e1; box-shadow:0 10px 20px #00000012 }
    .item .title{ font-weight:800; font-size:13px; color:#0f172a }
    .item .small{ font-size:12px; color:#64748b }

    .drawer-foot{ margin-top:auto; padding:12px 16px; display:flex; gap:8px; border-top:1px solid var(--edge); background:#f8fafc }
    .pill{ border:1px solid var(--edge); padding:6px 10px; border-radius:999px; background:#ffffff; color:#1f2937 }

    /* === Dialog Manage === */
    dialog{ border:none; width:min(700px, 96%); max-width:700px; padding:0; border-radius:18px; overflow:hidden; background:#ffffff; color:var(--text); box-shadow:0 30px 120px #00000022; }
    .dlg-head{ display:flex; justify-content:space-between; align-items:center; padding:16px 18px; background:#f8fafc; border-bottom:1px solid var(--edge) }
    .dlg-body{ padding:18px; display:grid; gap:12px }
    .dlg-foot{ display:flex; gap:8px; justify-content:flex-end; padding:14px 18px; border-top:1px solid var(--edge); background:#f8fafc }
    textarea{ width:100%; min-height:220px; resize:vertical; border-radius:12px; border:1px solid var(--edge); padding:12px; background:#ffffff; color:var(--text); font-size:14px; box-shadow:inset 0 1px 0 #00000005 }
    .hint{ color:var(--muted); font-size:12px }

    @media (max-width:720px){
      .wrap{ padding:16px }
      .front .big{ font-size: clamp(38px, 12vw, 64px); }
      .drawer{ width:100% }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>DeepTalk Pasangan</h1>
          <div class="hint">Kartu flip colorful â€¢ buka untuk lihat pertanyaan ðŸ’¬</div>
        </div>
      </div>
      <div class="controls">
        <button class="accent" id="btnToggle" title="Spasi / Enter / â†’">Buka/Tutup â–¸</button>
        <button id="btnList">Daftar</button>
        <button id="btnManage">Kelola</button>
        <button id="btnReset" class="ghost">Reset</button>
      </div>
    </header>

    <main class="stage">
      <section class="card" id="card" tabindex="0" role="button" aria-label="Kartu pertanyaan (ketuk untuk flip)">
        <div class="card-inner" id="cardInner">
          <div class="face front" id="front">
            <div class="label">
              <div class="num" id="frontNum">Pertanyaan #1</div>
              <div class="big">?</div>
              <div class="hint">Ketuk / Swipe untuk membuka</div>
            </div>
          </div>
          <div class="face back">
            <div class="q" id="question">â€”</div>
          </div>
        </div>
      </section>
      <div class="meta">
        <div><span class="pill" id="countBadge">0 pertanyaan</span></div>
        <div class="hint">Tip: Ketuk/Swipe untuk membuka pertanyaan. Ketuk lagi untuk menutup. Gunakan <strong>Daftar</strong> untuk lihat riwayat & semua pertanyaan.</div>
      </div>
    </main>
  </div>

  <!-- Drawer Daftar -->
  <aside class="drawer" id="drawer">
    <div class="drawer-head">
      <strong>Daftar Pertanyaan</strong>
      <button id="btnCloseDrawer">âœ•</button>
    </div>
    <div class="tabs">
      <button class="tab active" id="tabHistory">Riwayat</button>
      <button class="tab" id="tabAll">Semua</button>
    </div>
    <div class="drawer-body" id="list"></div>
    <div class="drawer-foot">
      <button id="btnExportList">Export JSON</button>
      <button id="btnClearHistory" class="ghost">Bersihkan Riwayat</button>
    </div>
  </aside>

  <!-- Dialog Manage -->
  <dialog id="dlg">
    <div class="dlg-head">
      <strong>Kelola Pertanyaan</strong>
      <button id="btnClose">âœ•</button>
    </div>
    <div class="dlg-body">
      <div class="hint">Tulis satu pertanyaan per baris. Kamu bisa <em>tambahkan</em> ke daftar yang ada atau <em>ganti seluruh</em> daftar.</div>
      <textarea id="txt"></textarea>
      <div class="hint">Total baris: <span id="lineCount">0</span></div>
    </div>
    <div class="dlg-foot">
      <button id="btnExport">Export</button>
      <input type="file" id="fileImport" accept="application/json" hidden />
      <button id="btnImport">Import</button>
      <div style="flex:1"></div>
      <button id="btnAdd">Tambahkan</button>
      <button id="btnReplace" class="primary">Ganti Daftar</button>
    </div>
  </dialog>

  <script>
  (()=>{
    // ===== Data Awal =====
    const DEFAULTS = [
  // ðŸŒ± Obrolan Ringan & Ice Breaking (1â€“25)
  "Apa makanan favorit kamu yang nggak pernah bikin bosen?",
  "Kalau bisa liburan ke mana aja, kamu pengen ke mana?",
  "Film atau series terakhir yang bikin kamu ketagihan?",
  "Lagu apa yang lagi sering kamu dengerin akhir-akhir ini?",
  "Kalau lagi bete, biasanya kamu ngapain biar mood balik lagi?",
  "Apa minuman yang bikin kamu langsung happy?",
  "Kamu lebih suka sunrise atau sunset? Kenapa?",
  "Apa tempat nongkrong favorit kamu?",
  "Kalau punya waktu kosong sehari penuh, kamu mau ngapain?",
  "Kamu lebih suka hujan atau panas?",
  "Hal kecil apa yang bikin kamu bahagia?",
  "Apa makanan masa kecil yang paling kamu kangenin?",
  "Kalau disuruh pilih: laut atau gunung?",
  "Apa aplikasi yang paling sering kamu buka di HP?",
  "Apa warna favoritmu dan kenapa?",
  "Kalau punya superpower sehari, kamu mau apa?",
  "Mainan masa kecil yang paling kamu inget apa?",
  "Kamu lebih suka nonton di bioskop atau di rumah?",
  "Apa snack wajib kalau lagi nonton film?",
  "Pernah nggak ketawa sampai nangis? Ceritain!",
  "Kalau bisa balik ke umur berapa, kamu mau balik umur berapa?",
  "Apa emoji yang paling sering kamu pake?",
  "Apa kebiasaan kecil kamu yang menurutmu unik?",
  "Kalau disuruh pilih: kopi atau teh?",
  "Apa hal random yang bisa bikin kamu langsung senyum?",

  // ðŸ’– Tentang Diri & Kehidupan (26â€“50)
  "Apa hal yang paling kamu banggakan dari dirimu?",
  "Apa pengalaman hidup yang paling berkesan buat kamu?",
  "Ada nggak momen yang bikin kamu merasa sangat bersyukur?",
  "Apa ketakutan terbesar kamu?",
  "Nilai hidup apa yang paling kamu pegang?",
  "Siapa orang yang paling berpengaruh dalam hidupmu?",
  "Pernah nggak kamu merasa benar-benar sendirian?",
  "Apa hal paling spontan yang pernah kamu lakukan?",
  "Kalau ada kesempatan belajar skill baru, kamu mau belajar apa?",
  "Apa mimpi masa kecil kamu yang belum tercapai?",
  "Bagaimana cara kamu menenangkan diri kalau lagi stres?",
  "Apa hadiah terbaik yang pernah kamu terima?",
  "Kamu tipe orang yang gampang cerita masalah atau lebih suka simpan sendiri?",
  "Pernah nggak kamu merasa benar-benar dicintai?",
  "Apa pencapaian kecil yang bikin kamu bangga?",
  "Kalau bisa ketemu diri kamu 10 tahun lalu, apa yang mau kamu bilang?",
  "Apa yang bikin kamu merasa dihargai?",
  "Hal paling lucu yang pernah kamu alami di sekolah?",
  "Siapa guru yang paling kamu ingat sampai sekarang?",
  "Apa pekerjaan impian kamu waktu kecil?",
  "Kalau bisa ganti satu keputusan hidup, apa yang mau kamu ubah?",
  "Apa hobi yang bikin kamu betah berjam-jam?",
  "Kalau punya uang tanpa batas, apa yang pertama kali kamu lakukan?",
  "Apa arti 'rumah' buat kamu?",
  "Apa kenangan masa remaja yang paling kocak?",

  // ðŸŒ¹ Tentang Hubungan & Perasaan (51â€“75)
  "Apa hal kecil dariku yang kamu suka?",
  "Kapan pertama kali kamu merasa nyaman sama aku?",
  "Kalau disuruh deskripsiin aku dengan tiga kata, apa?",
  "Apa kenangan pertama kali kita ketemu yang paling kamu ingat?",
  "Apa gesture romantis favoritmu?",
  "Menurut kamu, hal apa yang bikin hubungan kita unik?",
  "Apa hal yang bikin kamu merasa dicintai?",
  "Kalau aku bikin kamu kesel, biasanya apa yang paling ngeganggu?",
  "Apa kejutan paling kamu pengen dapat dariku?",
  "Menurut kamu, kita udah sejauh mana saling ngerti?",
  "Apa perbedaan kita yang paling kamu sadari?",
  "Apa kegiatan bareng yang paling kamu suka?",
  "Apa hal yang bikin kamu rindu kalau kita nggak ketemu lama?",
  "Menurutmu, pasangan yang sehat itu seperti apa?",
  "Apa hal paling lucu yang pernah kita alami bareng?",
  "Kalau kita punya satu hari bebas tanpa gangguan, kamu pengen ngapain bareng aku?",
  "Apa hal dari aku yang dulu bikin jatuh hati?",
  "Kalau kita lagi berantem, apa yang paling kamu harapin dariku?",
  "Hal apa yang bikin kamu semakin yakin sama aku?",
  "Kalau aku lagi down, apa cara terbaik buat bikin aku semangat lagi?",
  "Apa doa atau harapanmu buat hubungan kita?",
  "Menurutmu, apa kekuatan terbesar hubungan kita?",
  "Apa hal random yang bikin kamu senyum kalau inget aku?",
  "Apa hal kecil yang pengen kamu coba bareng aku tapi belum kesampaian?",
  "Kalau ada lagu yang cocok banget sama hubungan kita, menurutmu apa?",

  // ðŸŒŒ Topik Serius & Masa Depan (76â€“100)
  "Menurutmu, cinta itu apa?",
  "Apa arti kesetiaan buat kamu?",
  "Kalau suatu saat kita beda pendapat besar, gimana cara terbaik menyelesaikannya?",
  "Apa ketakutan terbesar kamu soal hubungan kita?",
  "Menurut kamu, apa tantangan terbesar buat hubungan kita ke depan?",
  "Apa arti pernikahan menurutmu?",
  "Apa yang paling kamu harapkan dari pasangan hidupmu kelak?",
  "Menurut kamu, gimana cara menjaga hubungan biar tetap langgeng?",
  "Kalau kita punya anak nanti, nilai apa yang paling ingin kamu ajarkan?",
  "Apa mimpi terbesar kamu untuk masa depan kita?",
  "Kalau aku lagi nggak ada, apa yang paling kamu rindukan dariku?",
  "Apa hal paling penting dalam membangun keluarga?",
  "Apa arti 'dewasa' buat kamu dalam hubungan?",
  "Kalau harus memilih, kamu lebih mementingkan passion atau stabilitas hidup?",
  "Bagaimana cara kamu menghadapi rasa cemburu?",
  "Menurutmu, apa batasan yang harus dijaga dalam hubungan?",
  "Apa pengorbanan terbesar yang rela kamu lakukan untuk orang yang kamu cintai?",
  "Apa yang paling bikin kamu takut kehilangan aku?",
  "Menurutmu, gimana cara kita tetap saling support walaupun sibuk?",
  "Apa yang paling kamu syukuri dari hubungan kita saat ini?",
  "Apa rencana besar yang ingin kamu capai sebelum menikah?",
  "Kalau ada masalah serius, siapa orang pertama yang akan kamu ceritain?",
  "Apa arti kebahagiaan bersama buat kamu?",
  "Kalau kita 10 tahun lagi, kamu bayangin kita lagi ngapain?",
  "Hal apa yang paling bikin kamu yakin untuk jalan bareng aku selamanya?"
];


    const KEY = 'deeptalk_questions_v1';
    const KEY_DECK = 'deeptalk_deck_v1';
    const KEY_HISTORY = 'deeptalk_history_v1';

    // ===== Elemen UI =====
    const card = document.getElementById('card');
    const cardInner = document.getElementById('cardInner');
    const questionEl = document.getElementById('question');
    const countBadge = document.getElementById('countBadge');
    const frontNum = document.getElementById('frontNum');

    const btnToggle = document.getElementById('btnToggle');
    const btnList = document.getElementById('btnList');
    const btnManage = document.getElementById('btnManage');
    const btnReset = document.getElementById('btnReset');

    const drawer = document.getElementById('drawer');
    const btnCloseDrawer = document.getElementById('btnCloseDrawer');
    const listBox = document.getElementById('list');
    const tabHistory = document.getElementById('tabHistory');
    const tabAll = document.getElementById('tabAll');
    const btnExportList = document.getElementById('btnExportList');
    const btnClearHistory = document.getElementById('btnClearHistory');

    const dlg = document.getElementById('dlg');
    const btnClose = document.getElementById('btnClose');
    const txt = document.getElementById('txt');
    const lineCount = document.getElementById('lineCount');
    const btnAdd = document.getElementById('btnAdd');
    const btnReplace = document.getElementById('btnReplace');
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const fileImport = document.getElementById('fileImport');

    // ===== State =====
    let questions = loadQuestions();
    let deck = loadDeck(questions);
    let history = loadHistory(); // array of {i:number, q:string, t:number}
    let revealed = false;
    let currentIdx = null;
    let shownCount = history.length; // lanjutan nomor dari panjang riwayat

    // ===== Utils =====
    function saveQuestions(list){
      localStorage.setItem(KEY, JSON.stringify(list));
      questions = list;
      deck = makeShuffledDeck(questions.length);
      saveDeck(deck);
      updateCount();
      updateFrontLabel();
      renderList();
    }

    function loadQuestions(){
      try{
        const raw = localStorage.getItem(KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed) && parsed.length) return parsed;
        }
      }catch(e){ console.warn(e); }
      localStorage.setItem(KEY, JSON.stringify(DEFAULTS));
      return [...DEFAULTS];
    }

    function makeShuffledDeck(n){
      const arr = Array.from({length:n}, (_,i)=>i);
      for(let i=n-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    function saveDeck(d){ localStorage.setItem(KEY_DECK, JSON.stringify(d)); }
    function loadDeck(list){
      try{
        const raw = localStorage.getItem(KEY_DECK);
        if(raw){
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed) && parsed.every(Number.isInteger) && parsed.length) return parsed;
        }
      }catch(e){ }
      const d = makeShuffledDeck(list.length); saveDeck(d); return d;
    }

    function loadHistory(){
      try{
        const raw = localStorage.getItem(KEY_HISTORY);
        if(raw){ const arr = JSON.parse(raw); if(Array.isArray(arr)) return arr; }
      }catch(e){}
      return [];
    }
    function saveHistory(){ localStorage.setItem(KEY_HISTORY, JSON.stringify(history)); }

    function updateCount(){ countBadge.textContent = `${questions.length} pertanyaan`; }
    function updateFrontLabel(){ frontNum.textContent = `Pertanyaan #${Math.max(1, shownCount+1)}`; }
    function vibrate(ms=18){ try{ if('vibrate' in navigator) navigator.vibrate(ms); }catch(_){} }

    function prepareNextIfNeeded(){
      if(currentIdx===null){
        if(deck.length===0){ deck = makeShuffledDeck(questions.length); saveDeck(deck); }
        currentIdx = deck.pop(); saveDeck(deck);
      }
    }

    function reveal(){
      prepareNextIfNeeded();
      const q = questions[currentIdx] || 'â€”';
      questionEl.textContent = q;
      card.classList.add('flipped'); revealed = true; vibrate(18);
      // catat ke riwayat sekali per index tampil
      history.push({ i: currentIdx, q, t: Date.now() });
      saveHistory();
      shownCount = history.length;
      renderList();
    }
    function hide(){
      card.classList.remove('flipped'); revealed = false; currentIdx = null; updateFrontLabel();
    }

    function toggleFlip(){ revealed ? hide() : reveal(); }

    // ===== List (drawer) =====
    function openDrawer(){ drawer.classList.add('open'); renderList(); }
    function closeDrawer(){ drawer.classList.remove('open'); }

    let activeTab = 'history';
    function renderList(){
      listBox.innerHTML = '';
      const frag = document.createDocumentFragment();
      if(activeTab==='history'){
        if(history.length===0){
          const empty = document.createElement('div');
          empty.className='hint';
          empty.textContent='Belum ada riwayat. Buka beberapa kartu dulu.';
          listBox.appendChild(empty);
        } else {
          // tampilkan terbaru di atas
          [...history].map((h,idx)=>({h, idx: history.length-idx})).reverse().forEach(({h, idx})=>{
            const el = document.createElement('div');
            el.className='item';
            el.innerHTML = `<div class="title">#${idx} â€¢ ${escapeHtml(h.q).slice(0,80)}</div>
                            <div class="small">Index ${h.i} â€¢ ${new Date(h.t).toLocaleString()}</div>`;
            el.addEventListener('click', ()=> selectFromList(h.i));
            frag.appendChild(el);
          });
        }
      } else {
        questions.forEach((q,i)=>{
          const el = document.createElement('div');
          el.className='item';
          el.innerHTML = `<div class="title">#${i+1} â€¢ ${escapeHtml(q).slice(0,80)}</div>
                          <div class="small">Klik untuk tampilkan</div>`;
          el.addEventListener('click', ()=> selectFromList(i));
          frag.appendChild(el);
        });
      }
      listBox.appendChild(frag);
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    function selectFromList(index){
      currentIdx = index;
      // pastikan back terisi & menunjukkan pertanyaan itu
      const q = questions[currentIdx] || 'â€”';
      questionEl.textContent = q;
      // buka sisi pertanyaan jika belum terbuka
      if(!revealed){ card.classList.add('flipped'); revealed = true; }
      vibrate(10);
    }

    // ===== Events: klik/keyboard =====
    card.addEventListener('click', toggleFlip);
    document.getElementById('btnToggle').addEventListener('click', toggleFlip);
    document.getElementById('btnList').addEventListener('click', openDrawer);
    btnCloseDrawer.addEventListener('click', closeDrawer);

    tabHistory.addEventListener('click', ()=>{ activeTab='history'; tabHistory.classList.add('active'); tabAll.classList.remove('active'); renderList(); });
    tabAll.addEventListener('click', ()=>{ activeTab='all'; tabAll.classList.add('active'); tabHistory.classList.remove('active'); renderList(); });

    document.addEventListener('keydown', (e)=>{
      if(['Space','Enter','N','ArrowRight',' '].includes(e.key)){
        if(document.activeElement && (document.activeElement.tagName==='TEXTAREA' || document.activeElement.tagName==='INPUT')) return;
        e.preventDefault();
        toggleFlip();
      }
      if(e.key==='Escape' && drawer.classList.contains('open')) closeDrawer();
    });

    // ===== Swipe (Mobile) =====
    let startX = 0, startY = 0, touching = false;
    card.addEventListener('touchstart', (e)=>{
      if(e.touches.length !== 1) return;
      touching = true;
      const t = e.touches[0];
      startX = t.clientX; startY = t.clientY;
    }, {passive:true});

    card.addEventListener('touchend', (e)=>{
      if(!touching) return; touching = false;
      const dx = (e.changedTouches?.[0]?.clientX || 0) - startX;
      const dy = (e.changedTouches?.[0]?.clientY || 0) - startY;
      if(Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 40){
        toggleFlip();
      }
    });

    // ===== Dialog Manage =====
    btnManage.addEventListener('click', ()=>{
      txt.value = questions.join('\n');
      updateLineCount();
      dlg.showModal();
    });
    btnClose.addEventListener('click', ()=> dlg.close());

    txt.addEventListener('input', updateLineCount);
    function updateLineCount(){
      const lines = txt.value.split(/\n/).filter(v=>v.trim().length>0);
      lineCount.textContent = lines.length;
    }

    btnAdd.addEventListener('click', ()=>{
      const lines = parseLines(txt.value);
      if(!lines.length){ dlg.close(); return; }
      const merged = uniq([...questions, ...lines]);
      saveQuestions(merged);
      dlg.close();
      updateFrontLabel();
    });

    btnReplace.addEventListener('click', ()=>{
      const lines = parseLines(txt.value);
      saveQuestions(uniq(lines));
      dlg.close();
      updateFrontLabel();
    });

    btnReset.addEventListener('click', ()=>{
      if(confirm('Kembalikan ke daftar default?')){
        saveQuestions([...DEFAULTS]);
        history = []; saveHistory();
        shownCount = 0; currentIdx = null; revealed = false; card.classList.remove('flipped');
        updateFrontLabel(); renderList();
      }
    });

    btnExport.addEventListener('click', ()=>{
      const data = { questions };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'deeptalk-pertanyaan.json'; a.click();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', ()=> fileImport.click());
    fileImport.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(Array.isArray(data)){
          saveQuestions(uniq(data.filter(v=>typeof v==='string')));
        } else if (Array.isArray(data.questions)){
          saveQuestions(uniq(data.questions.filter(v=>typeof v==='string')));
        } else {
          alert('Format tidak dikenali. Harus berupa array string atau {"questions": [...]}');
          return;
        }
        dlg.close(); updateFrontLabel(); renderList();
      }catch(err){ alert('Gagal import: '+err.message); }
      finally{ e.target.value=''; }
    });

    btnExportList.addEventListener('click', ()=>{
      const data = { history, questions };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='deeptalk-daftar.json'; a.click(); URL.revokeObjectURL(url);
    });
    btnClearHistory.addEventListener('click', ()=>{
      if(confirm('Bersihkan riwayat yang pernah ditampilkan?')){
        history = []; saveHistory(); shownCount = 0; updateFrontLabel(); renderList();
      }
    });

    // ===== Helpers =====
    function parseLines(text){ return text.split(/\n/).map(v=>v.trim()).filter(Boolean); }
    function uniq(arr){ return Array.from(new Set(arr.map(v=>v.trim()))); }

    // ===== Init =====
    updateCount();
    updateFrontLabel();
    renderList();

    // ===== Test Cases (console) =====
    (function runTests(){
      console.group('%cDeepTalk Flip + Daftar â€” Test Cases','color:#0ea5e9');
      console.assert(uniq(['a','a','b']).length===2, 'uniq harus menghapus duplikat');
      const d = makeShuffledDeck(10);
      console.assert(d.length===10 && d.every(i=> Number.isInteger(i) && i>=0 && i<10), 'deck valid');
      const before = history.length;
      // reveal mencatat riwayat & flip
      reveal();
      console.assert(history.length===before+1 && card.classList.contains('flipped'), 'reveal menambah riwayat & flip');
      // pilih dari list (by index 0 jika ada)
      if(questions[0]){ selectFromList(0); console.assert(revealed===true && questionEl.textContent, 'selectFromList menampilkan pertanyaan'); }
      // reset riwayat
      const lenBeforeClear = history.length; history=[]; saveHistory(); console.assert(lenBeforeClear>=0 && Array.isArray(history), 'bersihkan riwayat ok');
      hide(); console.assert(!revealed, 'hide menutup kartu');
      // âž• Extra tests
      console.assert(typeof btnReplace !== 'undefined' && typeof btnReplace.addEventListener === 'function', 'btnReplace.addEventListener tersedia');
      console.assert(escapeHtml('<>"&\'') === '&lt;&gt;&quot;&amp;&#39;', 'escapeHtml memetakan karakter spesial');
      console.groupEnd();
    })();
  })();
  </script>
</body>
</html>
